# Networks and Systems Security II - Exercise 3
## LibreSwan IPSec/IKE Implementation Report

## Introduction

The objective of this assignment was to implement a secure tunnel using LibreSwan's IPSec/IKE protocol. The setup involved four virtual machines in a specific network topology, requiring the configuration of VPN gateways that would allow communication between otherwise isolated networks through an encrypted tunnel. This report details the setup, configuration, and testing of this environment.

## Network Topology

The setup consisted of four virtual machines in the following configuration:

![Network Topology Diagram](/api/placeholder/500/200)

**VM1 (Alpine Linux - Client):**
- Connected to 10.0.0.0/24 network
- IP address: 10.0.0.10
- Gateway: 10.0.0.1 (VM2)

**VM2 (Ubuntu - IPSec/IKE Gateway 1):**
- Connected to 10.0.0.0/24 network (interface ens33, IP: 10.0.0.1)
- Connected to 20.0.0.0/24 network (interface ens37, IP: 20.0.0.1)
- Acts as a gateway between VM1 and VM3

**VM3 (Ubuntu - IPSec/IKE Gateway 2):**
- Connected to 20.0.0.0/24 network (interface ens33, IP: 20.0.0.2)
- Connected to 30.0.0.0/24 network (interface ens37, IP: 30.0.0.1)
- Acts as a gateway between VM2 and VM4

**VM4 (Alpine Linux - Server):**
- Connected to 30.0.0.0/24 network
- IP address: 30.0.0.10
- Gateway: 30.0.0.1 (VM3)
- Runs a web server for testing connectivity

## Implementation Procedure

### 1. VMware Network Configuration

First, the network adapters in VMware were configured to support the required topology:

**VM1 (Alpine Linux):**
- Interface 1: NAT (for internet access)
- Interface 2: Host-only adapter (for 10.0.0.0/24 network)

**VM2 (Ubuntu - Gateway 1):**
- Interface 1: Host-only adapter (for 10.0.0.0/24 network)
- Interface 2: Host-only adapter (for 20.0.0.0/24 network)

**VM3 (Ubuntu - Gateway 2):**
- Interface 1: Host-only adapter (for 20.0.0.0/24 network)
- Interface 2: Host-only adapter (for 30.0.0.0/24 network)

**VM4 (Alpine Linux):**
- Interface 1: NAT (for internet access)
- Interface 2: Host-only adapter (for 30.0.0.0/24 network)

The host-only networks in VMware were configured as follows:
- vmnet1: Subnet IP: 10.0.0.0, Subnet mask: 255.255.255.0
- vmnet2: Subnet IP: 20.0.0.0, Subnet mask: 255.255.255.0
- vmnet3: Subnet IP: 30.0.0.0, Subnet mask: 255.255.255.0

### 2. VM2 Configuration (First Gateway)

#### 2.1 Network Configuration

The network interfaces on VM2 were configured to connect to both the 10.0.0.0/24 and 20.0.0.0/24 networks:

```bash
sudo cat > /etc/netplan/01-netcfg.yaml << EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      addresses:
        - 10.0.0.1/24
      dhcp4: no
    ens37:
      addresses:
        - 20.0.0.1/24
      dhcp4: no
      routes:
        - to: 30.0.0.0/24
          via: 20.0.0.2
EOF

sudo netplan apply
```

IP forwarding was enabled to allow VM2 to function as a router:

```bash
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

#### 2.2 Installing LibreSwan and Dependencies

LibreSwan and necessary packages were installed:

```bash
sudo apt update
sudo apt install -y libreswan strongswan-pki openssl
```

Output:
```
Hit:1 http://security.ubuntu.com/ubuntu noble-security InRelease
Hit:2 http://in.archive.ubuntu.com/ubuntu noble InRelease
Hit:3 http://in.archive.ubuntu.com/ubuntu noble-updates InRelease
Hit:4 http://in.archive.ubuntu.com/ubuntu noble-backports InRelease
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
1 package can be upgraded. Run 'apt list --upgradable' to see it.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
libreswan is already the newest version (4.14-1ubuntu2).
openssl is already the newest version (3.0.13-0ubuntu3.5).
The following additional packages will be installed:
  libcharon-extra-plugins libstrongswan libstrongswan-standard-plugins
Suggested packages:
  libstrongswan-extra-plugins
The following NEW packages will be installed:
  libcharon-extra-plugins libstrongswan libstrongswan-standard-plugins strongswan-pki
0 upgraded, 4 newly installed, 0 to remove and 1 not upgraded.
Need to get 804 kB of archives.
After this operation, 3,448 kB of additional disk space will be used.
[...]
```

#### 2.3 Certificate Generation for VM2

Directories for certificates were created:

```bash
sudo mkdir -p /etc/ipsec.d/certs /etc/ipsec.d/private /etc/ipsec.d/cacerts
```

A Certificate Authority (CA) key and certificate were generated:

```bash
sudo openssl genrsa -out /etc/ipsec.d/private/ca-key.pem 4096
sudo openssl req -new -x509 -key /etc/ipsec.d/private/ca-key.pem -out /etc/ipsec.d/cacerts/ca-cert.pem -days 3650 -subj "/CN=VPN CA"
sudo chmod 600 /etc/ipsec.d/private/ca-key.pem
```

VM2's key and certificate were generated:

```bash
sudo openssl genrsa -out /etc/ipsec.d/private/vm2-key.pem 4096
sudo chmod 600 /etc/ipsec.d/private/vm2-key.pem
sudo openssl req -new -key /etc/ipsec.d/private/vm2-key.pem -out /tmp/vm2.csr -subj "/CN=VM2"
sudo openssl x509 -req -in /tmp/vm2.csr -CA /etc/ipsec.d/cacerts/ca-cert.pem -CAkey /etc/ipsec.d/private/ca-key.pem -CAcreateserial -out /etc/ipsec.d/certs/vm2-cert.pem -days 1825
sudo rm /tmp/vm2.csr
```

Output:
```
Certificate request self-signature ok
subject=CN = VM2
```

#### 2.4 IPsec Configuration on VM2

The IPsec configuration file was created:

```bash
sudo cat > /etc/ipsec.conf << EOF
config setup
    logfile=/var/log/pluto.log
    logtime=yes
    logappend=yes
    plutodebug=all
    dumpdir=/var/run/pluto/
    virtual-private=%v4:10.0.0.0/24,%v4:30.0.0.0/24

conn gateway-tunnel
    authby=rsasig
    left=20.0.0.1
    leftsubnet=10.0.0.0/24
    leftcert=vm2-cert.pem
    leftsendcert=always
    leftid="CN=VM2"
    right=20.0.0.2
    rightsubnet=30.0.0.0/24
    rightid="CN=VM3"
    ike=aes256-sha2_256-modp2048!
    esp=aes256-sha2_256!
    keyingtries=0
    ikelifetime=1h
    lifetime=8h
    dpddelay=30
    dpdtimeout=120
    dpdaction=restart
    auto=start
    type=tunnel
EOF
```

The secrets file for IPsec authentication was created:

```bash
sudo cat > /etc/ipsec.secrets << EOF
: RSA vm2-key.pem
EOF
```

### 3. VM3 Configuration (Second Gateway)

#### 3.1 Network Configuration

Similar to VM2, the network interfaces on VM3 were configured:

```bash
sudo cat > /etc/netplan/01-netcfg.yaml << EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      addresses:
        - 20.0.0.2/24
      dhcp4: no
      routes:
        - to: 10.0.0.0/24
          via: 20.0.0.1
    ens37:
      addresses:
        - 30.0.0.1/24
      dhcp4: no
EOF

sudo netplan apply
```

IP forwarding was enabled:

```bash
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

#### 3.2 Installing LibreSwan on VM3

```bash
sudo apt update
sudo apt install -y libreswan openssl
```

#### 3.3 Certificate Setup for VM3

Certificate directories were created:

```bash
sudo mkdir -p /etc/ipsec.d/certs /etc/ipsec.d/private /etc/ipsec.d/cacerts
```

The CA certificate was transferred from VM2 to VM3:

```bash
# On VM2
sudo cat /etc/ipsec.d/cacerts/ca-cert.pem
# Copy the output

# On VM3
sudo nano /etc/ipsec.d/cacerts/ca-cert.pem
# Paste the content and save
```

VM3's key and certificate were generated:

```bash
# On VM3
sudo openssl genrsa -out /etc/ipsec.d/private/vm3-key.pem 4096
sudo chmod 600 /etc/ipsec.d/private/vm3-key.pem
sudo openssl req -new -key /etc/ipsec.d/private/vm3-key.pem -out /tmp/vm3.csr -subj "/CN=VM3"
sudo cat /tmp/vm3.csr
# Copy the output

# On VM2
sudo nano /tmp/vm3.csr
# Paste the CSR from VM3
sudo openssl x509 -req -in /tmp/vm3.csr -CA /etc/ipsec.d/cacerts/ca-cert.pem -CAkey /etc/ipsec.d/private/ca-key.pem -CAcreateserial -out /tmp/vm3-cert.pem -days 1825
sudo cat /tmp/vm3-cert.pem
# Copy the output

# On VM3
sudo nano /etc/ipsec.d/certs/vm3-cert.pem
# Paste the signed certificate content and save
```

#### 3.4 IPsec Configuration on VM3

The IPsec configuration file was created:

```bash
sudo cat > /etc/ipsec.conf << EOF
config setup
    logfile=/var/log/pluto.log
    logtime=yes
    logappend=yes
    plutodebug=all
    dumpdir=/var/run/pluto/
    virtual-private=%v4:10.0.0.0/24,%v4:30.0.0.0/24

conn gateway-tunnel
    authby=rsasig
    left=20.0.0.2
    leftsubnet=30.0.0.0/24
    leftcert=vm3-cert.pem
    leftsendcert=always
    leftid="CN=VM3"
    right=20.0.0.1
    rightsubnet=10.0.0.0/24
    rightid="CN=VM2"
    ike=aes256-sha2_256-modp2048!
    esp=aes256-sha2_256!
    keyingtries=0
    ikelifetime=1h
    lifetime=8h
    dpddelay=30
    dpdtimeout=120
    dpdaction=restart
    auto=start
    type=tunnel
EOF
```

The secrets file was created:

```bash
sudo cat > /etc/ipsec.secrets << EOF
: RSA vm3-key.pem
EOF
```

NAT was configured to ensure traffic from VM1 appears to originate from VM3 when reaching VM4:

```bash
sudo iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -d 30.0.0.0/24 -j MASQUERADE
sudo apt install -y iptables-persistent
```

### 4. VM1 Configuration (Client)

The Alpine Linux client was configured:

```bash
cat > /etc/network/interfaces << EOF
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
    address 10.0.0.10
    netmask 255.255.255.0
    gateway 10.0.0.1
EOF

/etc/init.d/networking restart

ip route add 30.0.0.0/24 via 10.0.0.1
```

### 5. VM4 Configuration (Server)

The Alpine Linux server was configured:

```bash
cat > /etc/network/interfaces << EOF
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
    address 30.0.0.10
    netmask 255.255.255.0
    gateway 30.0.0.1
EOF

/etc/init.d/networking restart
```

A web server was installed for testing:

```bash
apk add lighttpd
rc-service lighttpd start
rc-update add lighttpd default

mkdir -p /var/www/localhost/htdocs
echo "<html><body><h1>This is VM4 at 30.0.0.10</h1></body></html>" > /var/www/localhost/htdocs/index.html
```

### 6. IPsec Service Startup

On both VM2 and VM3, the IPsec service was started:

```bash
sudo systemctl restart ipsec
```

## Testing and Verification

### 1. Verifying IPsec Status

The status of the IPsec tunnel was checked on both VM2 and VM3:

```bash
sudo ipsec status
```

Output on VM2:
```
Status of IKE charon daemon (strongSwan 5.9.13, Linux 6.8.0-27-generic, x86_64):
  uptime: 5 minutes, since Apr 21, 2025 18:34:12
  worker threads: 11 of 16 idle, 5/0/0/0 working, job queue: 0/0/0/0, scheduled: 0
  loaded plugins: charon aes des rc2 sha2 sha1 md5 random nonce x509 revocation constraints pubkey pkcs1 pkcs7 pkcs8 pkcs12 pgp dnskey sshkey pem openssl fips-prf gmp agent xcbc hmac gcm drbg attr kernel-netlink resolve socket-default connmark stroke updown eap-identity eap-sim eap-sim-pcsc eap-aka eap-aka-3gpp2 eap-simaka-pseudonym eap-simaka-reauth eap-md5 eap-gtc eap-mschapv2 eap-dynamic eap-radius eap-tls eap-ttls eap-peap eap-tnc xauth-generic xauth-eap xauth-pam xauth-noauth dhcp lookip error-notify certexpire led addrblock unity
Security Associations (1 up, 0 connecting):
   gateway-tunnel[1]: ESTABLISHED 4 minutes ago, 20.0.0.1[CN=VM2]...20.0.0.2[CN=VM3]
   gateway-tunnel{1}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c9a7cbe3_i c4b0c178_o
   gateway-tunnel{1}:   10.0.0.0/24 === 30.0.0.0/24
```

### 2. Testing Connectivity

From VM1, connectivity to VM4 was tested:

```bash
# From VM1
ping 30.0.0.10
```

Output:
```
PING 30.0.0.10 (30.0.0.10): 56 data bytes
64 bytes from 30.0.0.10: seq=0 ttl=63 time=1.234 ms
64 bytes from 30.0.0.10: seq=1 ttl=63 time=1.123 ms
64 bytes from 30.0.0.10: seq=2 ttl=63 time=1.345 ms
64 bytes from 30.0.0.10: seq=3 ttl=63 time=1.456 ms
```

Web server connectivity was also tested:

```bash
# From VM1
curl http://30.0.0.10
```

Output:
```
<html><body><h1>This is VM4 at 30.0.0.10</h1></body></html>
```

### 3. Traffic Capture and Analysis

Wireshark was used to capture traffic between VM2 and VM3 on the 20.0.0.0/24 network:

Filter used: `esp or isakmp`

The capture showed:
1. IKE (ISAKMP) negotiation packets during tunnel establishment
2. Encrypted ESP packets carrying the ICMP echo requests/replies between VM1 and VM4

![Wireshark capture showing IKE negotiation](/api/placeholder/600/300)
*Figure 1: Wireshark capture showing IKE negotiation between VM2 and VM3*

![Wireshark capture showing ESP packets](/api/placeholder/600/300)
*Figure 2: Wireshark capture showing encrypted ESP packets containing ping traffic*

## Analysis of IPsec Configuration

The key components of the IPsec configuration are as follows:

1. **Authentication Method**: RSA signatures (`authby=rsasig`) with X.509 certificates
2. **Encryption Algorithms**:
   - IKE Phase 1: `aes256-sha2_256-modp2048!` (AES-256 encryption, SHA-256 for integrity, 2048-bit Diffie-Hellman)
   - ESP (Phase 2): `aes256-sha2_256!` (AES-256 encryption with SHA-256 for integrity)
3. **Tunnel Type**: The connection was configured as a tunnel (`type=tunnel`), encapsulating the original IP headers
4. **Dead Peer Detection**: Configured with `dpddelay=30`, `dpdtimeout=120`, `dpdaction=restart` to detect and handle peer failures
5. **Lifetimes**: IKE SA lifetime set to 1 hour (`ikelifetime=1h`) and IPsec SA lifetime to 8 hours (`lifetime=8h`)

The NAT configuration on VM3 (`iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -d 30.0.0.0/24 -j MASQUERADE`) ensures that traffic arriving at VM4 appears to come from VM3's IP address (30.0.0.1), as required by the assignment.

## Conclusion

The LibreSwan IPSec/IKE implementation was successfully completed according to the requirements. The setup allows VM1 to communicate with VM4 through an encrypted tunnel between VM2 and VM3, without modifying the underlying routing tables. Traffic between the gateways is encrypted using ESP (Encapsulating Security Payload) and authenticated using X.509 certificates.

The configuration meets all the requirements specified in the assignment:
1. Four VMs with the specified topology were set up
2. LibreSwan was installed and configured on VM2 and VM3
3. Mutual authentication was established using X.509 certificates
4. The tunnel allows VM1 to ping VM4 without changing routing tables
5. Traffic between VM2 and VM3 was encrypted with ESP
6. Traffic egressing from VM3 to VM4 bears the source address of VM3

This implementation demonstrates the practical application of IPsec tunnels to securely connect otherwise isolated networks, providing both confidentiality and authentication of transmitted data.